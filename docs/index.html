<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <button id="connectButton" style="width: 100%;">连接</button>
    <input type="text" id="nameInput" style="width: 100%;">
    <button id="writeNameButton" style="width: 100%;">修改</button>
    <script>
        const connectButton = document.querySelector('#connectButton');
        const writeNameButton = document.querySelector('#writeNameButton');
        const nameInput = document.querySelector('#nameInput');
        function logProgress(x) {
            console.log("Progress:", x);
            return x;
        }
        function anyDeviceFilter() {
            // This is the closest we can get for now to get all devices.
            // https://github.com/WebBluetoothCG/web-bluetooth/issues/234
            return Array.from('0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ')
                .map(c => ({namePrefix: c}))
                .concat({name: ''});
        }
        connectButton.addEventListener('click', function () {
            Promise.resolve()
                .then(_ => {
                    if (!navigator.bluetooth)
                        throw "No Web Bluetooth support.";

                    return navigator.bluetooth.requestDevice({
                        filters: anyDeviceFilter(),
                        optionalServices: ['generic_access']
                    })
                })
                .then(logProgress)
                .then(device => {
                    return device.gatt.connect().catch(error => {
                        console.log(error);
                        throw "Unable to connect. Some devices refuse connections.";
                    });
                })
                .then(logProgress)
                .then(server => server.getPrimaryService("generic_access"))
                .then(logProgress)
                .then(service => service.getCharacteristic("gap.device_name"))
                .then(logProgress)
                .then(characteristic => {
                    window.deviceName = characteristic;
                    alert(characteristic);
                    return characteristic.readValue();
                })
        });

        writeNameButton.addEventListener('click', function () {
            Promise.resolve()
                .then(_ => {
                    let uint8arrayName = new TextEncoder("utf-8").encode(nameInput.value);
                    console.log("Writing: ", uint8arrayName);
                    alert(uint8arrayName);
                    return deviceName.writeValue(uint8arrayName)
                })
        });
    </script>
</body>
</html>