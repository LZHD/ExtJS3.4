<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="./js/extjs/css/ext-all.css">
    <script type="text/javascript" src="./js/extjs/js/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="./js/extjs/js/ext-all.js"></script>
    <script type="text/javascript" src="./js/extjs/js/ext-lang-zh_CN.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/4.2.2/math.js"></script>
</head>

<body>
    <div id="hello"></div>
    <script>
        Ext.onReady(function () {
            //array with data - dummy data
            var myData = [
                ['Meyers, Quyn R.', '5705141', 'Proin@nullamagna.ca', '05/13/1990'],
                ['Whitney, Tad T.', '7430343', 'vulputate@acurnaUt.org', '05/10/1987'],
                ['Lawrence, Flavia J.', '8264553', 'dapibus.id@accumsan.ca', '01/05/1988'],
                ['Morales, Susan I.', '7078084', 'tristique@seacmetus.com', '03/09/1992'],
                ['Merrill, Desiree Q.', '5460559', 'dictum.cursus@vel.ca', '01/07/1981'],
                ['Hampton, Willa Y.', '5628303', 'nascetur@stellus.ca', '06/17/1991'],
                ['Brewer, Brynne F.', '3024393', 'ligula@ullamcorper.org', '04/20/1989'],
                ['Marsh, Drew D.', '6712779', 'et.euismod.et@eget.ca', '02/13/1990']
            ];
            //data store - description of fields
            var store = new Ext.data.SimpleStore({
                fields: [
                    'name',
                    'price',
                    'email',
                    'birthday',
                    'test'
                ]
            });

            store.loadData(myData);

            // create the Grid
            var grid = new Ext.grid.GridPanel({
                id: 'static-grid',
                store: store,
                columns: [{
                        header: 'NAME',
                        width: 170,
                        sortable: true,
                        dataIndex: 'name'
                    },
                    {
                        header: '价格',
                        width: 150,
                        sortable: true,
                        dataIndex: 'price'
                    },
                    {
                        header: 'BIRTHDAY',
                        width: 100,
                        sortable: true,
                        dataIndex: 'birthday'
                    },
                    {
                        header: 'EMAIL',
                        width: 160,
                        sortable: true,
                        dataIndex: 'email'
                    },
                    {
                        header: '测试',
                        width: 100,
                        sortable: true,
                        dataIndex: 'test'
                    }
                ],
                stripeRows: true,
                autoHeight: true,
                width: 580,
                title: '联系资料'
            });

            var fp = new Ext.FormPanel({
                renderTo: 'hello',
                width: 800,
                frame: true,
                title: '计算器',
                autoHeight: true,
                bodyStyle: 'padding: 10px 10px 0 10px;',
                labelWidth: 50,
                defaults: {
                    anchor: '95%',
                    allowBlank: false,
                    msgTarget: 'side'
                },
                items: [{
                        layout: 'column',
                        xtype: 'panel',
                        bodyStyle: 'margin-bottom: 5px;',
                        items: [{
                            columnWidth: .16,
                            layout: 'fit',

                            items: [{
                                xtype: "button",
                                text: '+',
                                handler: function () {
                                    insertFocus("gs", this.getText());
                                }
                            }]
                        }, {
                            columnWidth: .16,
                            layout: 'fit',

                            items: [{
                                xtype: "button",
                                text: '-',
                                handler: function () {
                                    insertFocus("gs", this.getText());
                                }
                            }]
                        }, {
                            columnWidth: .16,
                            layout: 'fit',

                            items: [{
                                xtype: "button",
                                text: '*',
                                handler: function () {
                                    var text = Ext.getCmp("gs").getValue();
                                    Ext.getCmp("gs").setValue(text + this.getText());
                                }
                            }]
                        }, {
                            columnWidth: .16,
                            layout: 'fit',

                            items: [{
                                xtype: "button",
                                text: '/',
                                handler: function () {
                                    var text = Ext.getCmp("gs").getValue();
                                    Ext.getCmp("gs").setValue(text + this.getText());
                                }
                            }]
                        }, {
                            columnWidth: .16,
                            layout: 'fit',

                            items: [{
                                xtype: "button",
                                text: '(',
                                handler: function () {
                                    var text = Ext.getCmp("gs").getValue();
                                    Ext.getCmp("gs").setValue(text + this.getText());
                                }
                            }]
                        }, {
                            columnWidth: .16,
                            layout: 'fit',

                            items: [{
                                xtype: "button",
                                text: ')',
                                handler: function () {
                                    var text = Ext.getCmp("gs").getValue();
                                    Ext.getCmp("gs").setValue(text + this.getText());
                                }
                            }]
                        }]
                    },
                    {
                        id: 'gs',
                        xtype: 'textarea',
                        fieldLabel: '备注'
                    },
                    grid
                ],
                buttons: [{
                    text: '保存',
                    handler: function () {
                        var text = Ext.getCmp("gs").getValue();
                            var items = grid.store.data.items;
                            for (var i=0; i<items.length; i++) {
                                if (!formulaParser(items[i], text) && formulaParser(items[i], text) !== 0) {
                                    console.log("公式非法,请确认后重新输入");
                                    return;
                                }
                                items[i].data.test = formulaParser(items[i], text);
                            }
                            grid.getView().refresh();
                    }
                }, {
                    text: '重置',
                    handler: function () {
                        fp.getForm().reset();
                    }
                }]
            });
        });

        //公式解析
        formulaParser = function (item, formula) {
            var parameters = formula.split(/[+\-*\/()]/g);
            var formulaResult = formula;
            for (var i = 0; i < parameters.length; i++) {
                if (!parameters[i]) {
                    continue;
                }
                if (!item.data[parameters[i]]) {
                    return false;
                }
                formulaResult = formulaResult.replace(parameters[i], function (x) {
                    return item.data[parameters[i]];
                })
            }
            try {
                var parsed = math.parse(formulaResult);
                return math.round(parsed.compile().eval(), 3);
            } catch (e) {
                return false;
            }
        };
        //光标出插入内容
        insertFocus = function (targetId, text) {
            var target = Ext.getCmp(targetId);
            var targetValue = Ext.getCmp(targetId).getValue();
            var start = target.el.dom.selectionStart;
            var end = target.el.dom.selectionEnd;
            target.el.dom.setSelectionRange(start, end);
            target.setValue(targetValue.substring(0, start) + text + targetValue.substring(end));
        }
    </script>
</body>

</html>